#!/bin/bash

# Cargo emits build scripts inside the workspace. On WSL/DrvFs those paths often
# live on NTFS, and the hard-link strategy used during build script promotion
# can fail with intermittent ENOENT. When we detect a WSL kernel and no explicit
# CARGO_TARGET_DIR, redirect the target directory to an ext4-backed location
# under $HOME (overridable via RUN_ALL_CHECKS_TARGET_DIR) to avoid those errors.
if [[ -z "${CARGO_TARGET_DIR:-}" ]]; then
    kernel_release=$(uname -r 2>/dev/null || true)
    if [[ "$kernel_release" == *Microsoft* ]] || [[ "$kernel_release" == *microsoft* ]]; then
        export CARGO_TARGET_DIR="${RUN_ALL_CHECKS_TARGET_DIR:-$HOME/.cache/xi-editor-ph7/target}"
        mkdir -p "$CARGO_TARGET_DIR"
        printf 'Detected WSL kernel; using CARGO_TARGET_DIR=%s for builds.\n' "$CARGO_TARGET_DIR"
    fi
fi

if !(cargo clippy --version); then
    printf 'Checks requires clippy; try `rustup component add clippy-preview`.\n'
    printf "If that doesn't fix things; try `rustup self update`.\n"
    exit 1
fi

if !(cargo fmt --version); then
    printf 'Checks requires rustfmt; try `rustup component add rustfmt-preview`.\n'
    printf "If that doesn't fix things; try `rustup self update`.\n"
    exit 1
fi

printf 'Running rustfmt:\n'

if ! (cargo fmt --all -- --check); then
    printf '\nRustfmt failed. Please run rustfmt.\n'
    exit $?
fi

printf 'Rustfmt check passed.\n'

printf 'Running clippy:\n'

if ! (cargo clippy --all -- -D warnings); then
    printf '\nClippy has nits. :(\n'
    exit $?
fi

printf 'Clippy check passed.\n'


printf 'Checking compiler warnings:\n'

if ! (RUSTFLAGS="-D warnings" cargo check --all); then
    printf '\nCargo check produced errors. Exiting.\n'
    exit $?
fi

printf 'Check passed!\n'

printf 'Running "cargo test --all"\n'

if ! (cargo test --all); then
    exit $?
fi

printf 'Running "cargo test -p xi-rope --no-default-features"\n'

if ! (cargo test -p xi-rope --no-default-features); then
    exit $?
fi

printf 'Running "cargo test -p xi-rope --features serde"\n'

if ! (cargo test -p xi-rope --features serde); then
    exit $?
fi

printf 'Tests passed!\n'
printf 'Benchmarks are disabled in xi-editor-ph7; skipping cargo bench.\n'
printf 'Workspace limited to core crates (xi-core, xi-core-lib, xi-plugin-lib, xi-rope, xi-rpc, xi-trace, xi-unicode).\n'

printf 'All checks passed.\n'
